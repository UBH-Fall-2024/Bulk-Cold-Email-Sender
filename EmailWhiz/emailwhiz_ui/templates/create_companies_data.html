<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update API Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container mx-auto py-10 px-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Side: Inputs -->
        <div>
            <h2 class="text-2xl font-bold mb-4">API 1 Data Collection</h2>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Organization Locations</label>
                <textarea id="locations" class="w-full p-2 border rounded" placeholder="Enter locations, one per line"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Keywords</label>
                <textarea id="keywords" class="w-full p-2 border rounded" placeholder="Enter keywords, one per line"></textarea>
            </div>

            <button
                onclick="getTotalCount()"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
                id="get-total-count-btn"
            >
                Get Total Count
            </button>

            <div id="json-file-section" class="hidden mt-4">
                <label class="block text-sm font-medium mb-1">Output JSON File Name</label>
                <input type="text" id="output-file" class="w-full p-2 border rounded" placeholder="example.json" />
                <button
                    onclick="startDataCollection()"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mt-2"
                    id="start-data-collection-btn"
                >
                    Start Data Collection
                </button>
            </div>
        </div>

        <!-- Right Side: Display API Response and Progress -->
        <div>
            <h2 class="text-2xl font-bold mb-4">API Progress</h2>
            <div id="progress-section" class="hidden">
                <p class="text-sm mb-2">Companies Fetched: <span id="companies-fetched">0</span> / <span id="total-companies">0</span></p>
                <div class="h-2 bg-gray-200 rounded">
                    <div id="progress-bar" class="h-2 bg-blue-500 rounded" style="width: 0%;"></div>
                </div>
            </div>
            <pre
                id="api-response"
                class="bg-gray-100 p-4 border rounded text-sm overflow-x-auto max-h-96 mt-4"
            >Response will appear here...</pre>
        </div>
    </div>
  </div>

  <script>
  let totalCount = 0; // Stores the total number of companies
  let companiesFetched = 0; // Stores the number of companies fetched so far
  let totalPages = 0; // Stores the total number of pages

  function getTotalCount() {
    const locations = document.getElementById('locations').value.split('\n').filter(x => x.trim());
    const keywords = document.getElementById('keywords').value.split('\n').filter(x => x.trim());

    if (!locations.length || !keywords.length) {
      alert('Please fill in both the locations and keywords!');
      return;
    }

    // Show loading state and hide the button
    document.getElementById('get-total-count-btn').disabled = true;
    document.getElementById('get-total-count-btn').textContent = 'Fetching Total Count...';

    fetch('/api/get-companies-id/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({
        locations,
        keywords
      }),
    })
    .then(response => response.json())
    .then(data => {
      console.log("Data: ", data);
      totalCount = data.pagination.total_entries;
      if (totalCount > 125) {
        totalPages = 5;
        }
      else {
        totalPages = Math.ceil(totalCount / 25);
      }
        
      // totalPages = 2

      document.getElementById('total-companies').textContent = totalCount;
      document.getElementById('progress-section').classList.remove('hidden');
      document.getElementById('json-file-section').classList.remove('hidden');
      document.getElementById('get-total-count-btn').textContent = 'Total Count Fetched';
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to fetch total count!');
      document.getElementById('get-total-count-btn').disabled = false;
      document.getElementById('get-total-count-btn').textContent = 'Get Total Count';
    });
  }

  async function startDataCollection() {
    const outputFile = document.getElementById('output-file').value.trim();
    if (!outputFile) {
      alert('Please enter an output JSON file name!');
      return;
    }

    document.getElementById('start-data-collection-btn').disabled = true;
    document.getElementById('start-data-collection-btn').textContent = 'Collecting Data...';

    companiesFetched = 0;
    document.getElementById('companies-fetched').textContent = companiesFetched;

    for (let page = 1; page <= totalPages; page++) {
      try {
        const response = await fetch('/api/get-companies-id/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: JSON.stringify({
            locations: document.getElementById('locations').value.split('\n').filter(x => x.trim()),
            keywords: document.getElementById('keywords').value.split('\n').filter(x => x.trim()),
            page: page,
            json_file_name: outputFile
          }),
        });

        const data = await response.json();
        companiesFetched += data.organizations.length;
        document.getElementById('companies-fetched').textContent = companiesFetched;
        document.getElementById('progress-bar').style.width = `${(companiesFetched / totalCount) * 100}%`;

        console.log(`Page ${page} data:`, data);
      } catch (error) {
        console.error(`Error fetching page ${page}:`, error);
        alert(`Failed to fetch data for page ${page}`);
      }
    }

    document.getElementById('start-data-collection-btn').disabled = false;
    document.getElementById('start-data-collection-btn').textContent = 'Start Data Collection';
  }
  </script>

</body>
</html>
